{"version":3,"file":"js-data-express.js","sources":["../src/queryParser.js","../src/index.js"],"sourcesContent":["export function parseQuery (query) {\n  if (query.where) {\n    try {\n      query.where = JSON.parse(query.where)\n    } catch (err) {}\n  }\n  if (query.orderBy || query.sort) {\n    const orderBy = query.orderBy || query.sort\n    if (orderBy.length) {\n      query.orderBy = orderBy.map((clause) => {\n        if (typeof clause === 'string') {\n          return JSON.parse(clause)\n        }\n        return clause\n      })\n      query.sort = undefined\n    }\n  }\n}\n\nexport function queryParser (req, res, next) {\n  req.jsdataOpts || (req.jsdataOpts = {})\n  if (req.query.with) {\n    req.jsdataOpts.with = req.query.with\n    delete req.query.with\n  }\n  try {\n    parseQuery(req.query)\n    next()\n  } catch (err) {\n    next(err)\n  }\n}\n","import {\n  Component,\n  Container,\n  Mapper,\n  utils\n} from 'js-data'\n\nimport {queryParser} from './queryParser'\nexport * from './queryParser'\nimport express from 'express'\nimport bodyParser from 'body-parser'\n\nfunction makeHandler (handler) {\n  return function (req, res, next) {\n    return utils.resolve()\n      .then(function () {\n        return handler(req)\n      })\n      .then(function (result) {\n        res.status(200)\n        if (!utils.isUndefined(result)) {\n          res.send(result)\n        }\n        res.end()\n      })\n      .catch(next)\n  }\n}\n\nexport function Router (component) {\n  if (!(component instanceof Mapper) && !(component instanceof Container)) {\n    throw new Error('You must provide an instance of JSData.Container, JSData.DataStore, or JSData.Mapper!')\n  }\n\n  const router = this.router = express.Router()\n  router.use(bodyParser.json())\n  router.use(bodyParser.urlencoded({\n    extended: true\n  }))\n\n  if (component instanceof Container) {\n    utils.forOwn(component._mappers, (mapper, name) => {\n      router.use(`/${mapper.endpoint || name}`, new Router(mapper).router)\n    })\n  } else if (component instanceof Mapper) {\n    router.route('/')\n      // GET /:resource\n      .get(makeHandler(function (req) {\n        return component.findAll(req.query, req.jsdataOpts)\n      }))\n      // POST /:resource\n      .post(makeHandler(function (req) {\n        if (utils.isArray(req.body)) {\n          return component.createMany(req.body, req.jsdataOpts)\n        }\n        return component.create(req.body, req.jsdataOpts)\n      }))\n      // PUT /:resource\n      .put(makeHandler(function (req) {\n        if (utils.isArray(req.body)) {\n          return component.updateMany(req.body, req.jsdataOpts)\n        }\n        return component.updateAll(req.body, req.query, req.jsdataOpts)\n      }))\n      // DELETE /:resource\n      .delete(makeHandler(function (req) {\n        return component.destroyAll(req.query, req.jsdataOpts)\n      }))\n\n    router.route('/:id')\n      // GET /:resource/:id\n      .get(makeHandler(function (req) {\n        return component.find(req.params.id, req.jsdataOpts)\n      }))\n      // PUT /:resource/:id\n      .put(makeHandler(function (req) {\n        return component.update(req.params.id, req.body, req.jsdataOpts)\n      }))\n      // DELETE /:resource/:id\n      .delete(makeHandler(function (req) {\n        return component.destroy(req.params.id, req.jsdataOpts)\n      }))\n  }\n}\n\nComponent.extend({\n  constructor: Router\n})\n\n/**\n * Convenience method that mounts {@link queryParser} and a store.\n *\n * @example <caption>Mount queryParser and store at \"/\"</caption>\n * import express from 'express'\n * import {mount, queryParser, Router} from 'js-data-express'\n * import {Container} from 'js-data'\n *\n * const app = express()\n * const store = new Container()\n * const UserMapper = store.defineMapper('user')\n * const CommentMapper = store.defineMapper('comment')\n * mount(app, store)\n *\n * @example <caption>Mount queryParser and store at \"/api\"</caption>\n * mount(app, store, '/api')\n *\n * @name module:js-data-express.mount\n * @type {Function}\n * @param {*} app\n * @param {*} store\n * @param {string} [path]\n */\nexport function mount (app, store, path) {\n  if (!(store instanceof Container)) {\n    throw new Error('You must provide an instance of JSData.Container or JSData.DataStore!')\n  }\n  path || (path = '/')\n  app.use(path, queryParser)\n  app.use(path, new Router(store).router)\n}\n\n/**\n * Details of the current version of the `js-data-express` module.\n *\n * @example <caption>ES2015 modules import</caption>\n * import {version} from 'js-data-express'\n * console.log(version.full)\n *\n * @example <caption>CommonJS import</caption>\n * var version = require('js-data-express').version\n * console.log(version.full)\n *\n * @name module:js-data-express.version\n * @type {Object}\n * @property {string} version.full The full semver value.\n * @property {number} version.major The major version number.\n * @property {number} version.minor The minor version number.\n * @property {number} version.patch The patch version number.\n * @property {(string|boolean)} version.alpha The alpha version value,\n * otherwise `false` if the current version is not alpha.\n * @property {(string|boolean)} version.beta The beta version value,\n * otherwise `false` if the current version is not beta.\n */\nexport const version = '<%= version %>'\n\n/**\n * {@link Router} class.\n *\n * @example <caption>ES2015 modules import</caption>\n * import {Router} from 'js-data-express'\n * const adapter = new Router()\n *\n * @example <caption>CommonJS import</caption>\n * var Router = require('js-data-express').Router\n * var adapter = new Router()\n *\n * @name module:js-data-express.Router\n * @see Router\n * @type {Constructor}\n */\n\n/**\n * Registered as `js-data-express` in NPM.\n *\n * @example <caption>Install from NPM</caption>\n * npm i --save js-data-express@beta js-data@beta\n *\n * @example <caption>ES2015 modules import</caption>\n * import {Router} from 'js-data-express'\n * const adapter = new Router()\n *\n * @example <caption>CommonJS import</caption>\n * var Router = require('js-data-express').Router\n * var adapter = new Router()\n *\n * @module js-data-express\n */\n"],"names":["utils","Mapper","Container","Component"],"mappings":"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"}